---
title: "Historic district analysi"
author: "Pete Rodrigue & Bob Ward"
date: "2025-08-23"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE, message=F, warning=F, fig.width = 18, fig.height = 8)
library(readr)
library(sf)
library(leaflet)
library(rstudioapi)
library(dplyr)
library(ggplot2)
library(patchwork)
```

Set working directory to the place this script is saved:

```{r}
# Getting the path of your current open file
current_path = rstudioapi::getActiveDocumentContext()$path 
setwd(dirname(current_path))
```

Load our data:

```{r}
# load data that has the dates the historic districts were designated
# comes from here: https://planning.dc.gov/page/dc-historic-districts
# hd_data <- readr::read_csv("https://docs.google.com/spreadsheets/d/1Ajl1iAS0NRB7vk_UFDveeWzGkwf3tuiDo-zV9_wtzRM/gviz/tq?tqx=out:csv&sheet=data")
hd_data <- readr::read_csv("hd_data/data.csv")

# load the historic district boundary shape files
# comes from here: https://opendata.dc.gov/datasets/DCGIS::historic-districts/about 
hd_shp <- sf::st_read("Historic_Districts/Historic_Districts.shp")

# load the 2022 ward shape files
# comes from here: https://opendata.dc.gov/datasets/DCGIS::wards-from-2022/about
ward_shp <- sf::st_read("Wards_from_2022/Wards_from_2022.shp")

# load the zoning map:
# comes from here: https://opendata.dc.gov/datasets/DCGIS::zoning-boundaries-zoning-regulations-of-2016/about
zone_shp <- sf::st_read("zoning/Zoning_Boundaries_(Zoning_Regulations_of_2016).shp")

# load census demographic data
# comes from NHGIS; the table is called nhgis0091_ts_nominal_tract
tract_dem <- read_csv("census_race/nhgis0091_csv/nhgis0091_ts_nominal_tract.csv")

# load census tract shapefiles
# Comes from NHGIS
clean_census_data <- function(fpath, fip_var, value, joiny, year) {
  shp <- sf::st_read(fpath)
  shp <- shp[shp[[fip_var]]==value,]
  shp <- sf::st_transform(shp, 4326)
  shp <- dplyr::left_join(x = shp, y = tract_dem, by = c("GISJOIN" = joiny))
  shp[[paste0("totalpop", year)]] <- shp[[paste0("B18AA", year)]] +
                                     shp[[paste0("B18AB", year)]] +
                                     shp[[paste0("B18AC", year)]] +
                                     shp[[paste0("B18AD", year)]]
  if (year >= 2000) {
    shp[[paste0("totalpop", year)]] <- shp[[paste0("totalpop", year)]] +
                                       shp[[paste0("B18AE", year)]]
  }
  shp[[paste0("pctblack", year)]] <- shp[[paste0("B18AB", year)]] /
                                             shp[[paste0("totalpop", year)]]
  shp[[paste0("pctwhite", year)]] <- shp[[paste0("B18AA", year)]] / 
                                             shp[[paste0("totalpop", year)]]
  
  shp <- shp[, c("GISJOIN", paste0("NAME", year), paste0("totalpop", year), paste0("pctwhite", year), paste0("pctblack", year))]
  
  return(shp)
}
c70_shp <- clean_census_data("census shapefiles/nhgis0091_shapefile_tl2000_us_tract_1970/US_tract_1970.shp", 
                             "NHGISST", "110", "GJOIN1970", "1970")
c80_shp <- clean_census_data("census shapefiles/nhgis0091_shapefile_tl2000_us_tract_1980/US_tract_1980.shp",
                             "NHGISST", "110", "GJOIN1980", "1980")
c90_shp <- clean_census_data("census shapefiles/nhgis0091_shapefile_tl2000_us_tract_1990/US_tract_1990.shp", 
                             "NHGISST", "110", "GJOIN1990", "1990")
gc()
c00_shp <- clean_census_data("census shapefiles/nhgis0091_shapefile_tl2000_us_tract_2000/US_tract_2000.shp", 
                             "NHGISST", "110", "GJOIN2000", "2000")
c10_shp <- clean_census_data("census shapefiles/nhgis0091_shapefile_tl2010_us_tract_2010/US_tract_2010.shp", 
                             "STATEFP10", "11", "GJOIN2010", "2010")
c20_shp <- clean_census_data("census shapefiles/nhgis0091_shapefile_tl2020_us_tract_2020/US_tract_2020.shp", 
                             "STATEFP", "11", "GJOIN2020", "2020")
gc()

# format of the variables we'll look at:
# B18AAYEAR:   YEAR: Persons: White (single race)
# B18ABYEAR:   YEAR: Persons: Black or African American (single race)

```


Merge HD data onto HD shapefile, subset to only look at neighborhood HDs:

```{r}
hd_shp <- dplyr::left_join(x = hd_shp, y = hd_data, by = "UNIQUEID")
hd_shp <- hd_shp[hd_shp$Neighborhood_HD==1,]
```

Transform shape files to mercator projection:

```{r}
# convert to mercator projection
zone_shp <- sf::st_transform(zone_shp, 4326)
hd_shp <- sf::st_transform(hd_shp, 4326)
ward_shp <- sf::st_transform(ward_shp, 4326)
```

Subset the zoning map to just look at residential zones:

```{r}
# list zones:
zones_list <- sort(unique(zone_shp$ZR16))
housing_zones <- zones_list[grep(x=zones_list, pattern = "^R|^MU")]
# subset
zone_shp <- zone_shp[zone_shp$ZR16 %in% housing_zones,]

# create simplified labels
zone_shp$ZR16_simple <- "Other"
zone_shp$ZR16_simple[grep(x=zone_shp$ZR16, pattern="^RA-")] <- "Apartment zones"
zone_shp$ZR16_simple[grep(x=zone_shp$ZR16, pattern="^R-")] <- "Residential zones"
zone_shp$ZR16_simple[grep(x=zone_shp$ZR16, pattern="^RF-")] <- "Residential flat zones"
zone_shp$ZR16_simple[grep(x=zone_shp$ZR16, pattern="^MU-")] <- "Mixed use zones"

# show on a map:
factpal <- colorFactor(palette = "Set1", domain = zone_shp$ZR16_simple)

leaflet(zone_shp) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(fillColor = ~factpal(ZR16_simple), # Apply the color function
              fillOpacity = 0.7,
              weight = 1,
              opacity = 1,
              color = "white",
              label=~ZR16,
              highlightOptions = highlightOptions(weight = 3,
                                                  color = "white",
                                                  bringToFront = TRUE
        )
  ) %>%
  addLegend(pal = factpal, values = ~ZR16_simple, opacity = 0.7, title = NULL,
    position = "bottomright")
```


Calculate the total amount of residential and MU land in DC:

```{r}
# first, need to fix broken geometry:
if (min(sf::st_is_valid(zone_shp)) == 0) {
  print("Fixing zone geometry...")
  zone_shp <- sf::st_make_valid(zone_shp)
}

zone_shp$area_meters <- sf::st_area(zone_shp)
zone_shp$area_acres <- as.vector(zone_shp$area_meters * 0.000247105)
total_zone_acres <- sum(zone_shp$area_acres, na.rm=T)
```


Total land area covered by HDs over time:

```{r}
# get shape areas:
hd_shp$area_meters <- sf::st_area(hd_shp)
hd_shp$area_acres <- as.vector(hd_shp$area_meters * 0.000247105)

years <- c(1980, 1990, 2000, 2010, 2025)
land_areas <- rep(NA, length(years))
counter <- 1
for (year in years) {
  land_area <- sum(hd_shp$area_acres[hd_shp$desig_date < year])
  land_areas[counter] <- land_area
  counter <- counter + 1
}

p <- data.frame(years, land_areas, round(100*land_areas / total_zone_acres,0))
names(p) <- c("Year", 
              "Area covered by by Historic Districts, in Acres",
              "Percent of 2016 residential zone covered by Neighborhood HD")
plot1 <-
  ggplot(p, 
       aes(x=Year, 
           y=`Area covered by by Historic Districts, in Acres`)) + 
  geom_bar(stat = "identity", fill="#0f9535") +
  geom_text(aes(label = round(`Area covered by by Historic Districts, in Acres`, 0), vjust = -1.7)) +
  ylab("Acres") +
  theme_minimal() +
  ggtitle('Acres covered by "neighborhood historic districts" has steadily increased over time')

plot2 <-
  ggplot(p, 
       aes(x=Year, 
           y=`Percent of 2016 residential zone covered by Neighborhood HD`)) + 
  geom_line(color="#0f9535", size=.75) +
  geom_point(color="#0f9535") +
  geom_text(aes(label = paste0(`Percent of 2016 residential zone covered by Neighborhood HD`, "%")), vjust = -1.7) +
  theme_minimal() +
  ylab("Percent") +
  ggtitle('And the % of residential area covered by HDs has more than doubled since 1980')

plot1 + plot2
```


Let's quickly compare which HDs were designated before vs after 1980:

```{r}

hd_shp$flag_1980 <- 0
hd_shp$flag_1980[hd_shp$desig_date < 1980] <- 1

leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(group= "Designated before 1980",
              data=hd_shp[hd_shp$flag_1980==1,],
              fillColor = "skyblue", 
              fillOpacity = 0.7,
              weight = 1,
              opacity = 1,
              color = "white",
              label=~LABEL,
              highlightOptions = highlightOptions(weight = 3,
                                                  color = "white",
                                                  bringToFront = FALSE
        ) 
  ) %>%
  addPolygons(group= "Designated after 1980",
              data=hd_shp[hd_shp$flag_1980==0,],
              fillColor = "hotpink", 
              fillOpacity = 0.7,
              weight = 1,
              opacity = 1,
              color = "white",
              label=~LABEL,
              highlightOptions = highlightOptions(weight = 3,
                                                  color = "white",
                                                  bringToFront = FALSE
        ) 
  ) %>%
  addLayersControl(
    overlayGroups = c("Designated before 1980", "Designated after 1980"),
    options = layersControlOptions(collapsed = FALSE)
  )

```


Now let's look and see how HD changed over time, in terms of % black residents and % white residents, compared to nearby neighborhoods (tracts) that were not in HDs.

This will have a few steps:

1. Take a given HD.
2. Get the intersection of the HD with census tracts. If at least X% of the census tract area is in the HD, we'll count it as part of the HD. (We'll vary X as robustness check later)
3. Create a buffer around the HD of distance Y (we'll vary Y as a robustness check later). Run another intersection with the census tracts and that buffer. Count any tracts that touch the buffer but are not in an HD as "comparison" tracts. 
4. Note the % of white and black residents in each HD and those HDs comparison tracts.
5. See how that changes over time.


```{r}

get_tracts_in_hd <- function(shp, min_pct, year) {
  # get the tracts that are in each HD in a given year
  shp$tract_area <- sf::st_area(shp)
  
  i <- sf::st_intersection(x=shp, 
                            y=hd_shp)
  i$i_area <- sf::st_area(i)
  i$pct_of_tract_area <- as.vector(i$i_area / i$tract_area)
  
  names(i) <- gsub(x = names(i), pattern=year, replacement = "")
  tracts_in_hd <- i[i$pct_of_tract_area > min_pct, 
                    c("GISJOIN", "LABEL",
                      "NAME", "totalpop", "pctwhite", "pctblack",
                      "desig_date", "pct_of_tract_area")]
  tracts_in_hd_summary <-
    tracts_in_hd %>%
    mutate(num_black_prorated = totalpop * pctblack * pct_of_tract_area,
           num_white_prorated = totalpop * pctwhite * pct_of_tract_area) %>%
    select("LABEL", starts_with("num_"), "desig_date") %>%
    group_by(LABEL) %>%
      summarise(num_black_prorated = sum(num_black_prorated),
                num_white_prorated = sum(num_white_prorated),
                desig_year = max(desig_date, na.rm=T)) %>%
    mutate(pct_black_prorated = num_black_prorated / (num_black_prorated + num_white_prorated),
           pct_white_prorated = num_white_prorated / (num_black_prorated + num_white_prorated),
           desig_yet = ifelse(desig_year<year, 1, 0),
           year = year)
  
    rv = list("tracts_in_hd"=tracts_in_hd, "summary"=sf::st_drop_geometry(tracts_in_hd_summary))
    
    return(rv)
}

# ranging the min % between .3 and .6 seems to give reasonable results
hd_tracts70 <- get_tracts_in_hd(c70_shp, min_pct = .3, year = 1970)
hd_tracts80 <- get_tracts_in_hd(c80_shp, min_pct = .3, year = 1980)
hd_tracts90 <- get_tracts_in_hd(c90_shp, min_pct = .3, year = 1990)
hd_tracts00 <- get_tracts_in_hd(c00_shp, min_pct = .3, year = 2000)
hd_tracts10 <- get_tracts_in_hd(c10_shp, min_pct = .3, year = 2010)
hd_tracts20 <- get_tracts_in_hd(c20_shp, min_pct = .3, year = 2020)
gc()
```

Plot where the tracts "inside" the HDs were for 2020:

```{r}
leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(group= "tracts labeled as in HDs",
              data=c20_shp[c20_shp$GISJOIN %in% hd_tracts20[["tracts_in_hd"]]$GISJOIN,],
              fillColor = "skyblue", 
              fillOpacity = 0.7,
              weight = 1,
              opacity = 1,
              color = "white",
              label=~NAME2020,
              highlightOptions = highlightOptions(weight = 3,
                                                  color = "white",
                                                  bringToFront = FALSE
        ) 
  ) %>%
  addPolygons(group= "HDs",
              data=hd_shp,
              fillColor = "hotpink", 
              fillOpacity = 0.7,
              weight = 1,
              opacity = 1,
              color = "white",
              label=~LABEL,
              highlightOptions = highlightOptions(weight = 3,
                                                  color = "white",
                                                  bringToFront = FALSE
        ) 
  ) %>%
  addLayersControl(
    overlayGroups = c("tracts labeled as in HDs", "HDs"),
    options = layersControlOptions(collapsed = FALSE)
  )

```

Now get a list of neighboring tracts:

```{r}
get_neighbor_tracts <- function(hd_shp, c_shp, buffer_dist, tracts_in_hd, remove_tract_thresh, year) {
  # first make a buffer around the HDs
  b <- sf::st_buffer(hd_shp, dist = buffer_dist)
  # then get the intersection of the buffer and the tracts
  i <- sf::st_intersection(x=c_shp, y=b)
  # remove tracts that have already been classified as within an HD
  i <- i[!(i$GISJOIN %in% tracts_in_hd$GISJOIN),]
  # also remove any tracts for which more than X% of an HD is in that tract
  hd_tract <- sf::st_intersection(x=c_shp, y=hd_shp)
  hd_tract$intersect_area <- sf::st_area(hd_tract)
  hd_tract$pct_area <- as.vector(hd_tract$intersect_area / hd_tract$area_meters)
  tracts_to_remove <- hd_tract$GISJOIN[hd_tract$pct_area > remove_tract_thresh]
  
  neighboring_tracts <- i[!(i$GISJOIN %in% tracts_to_remove),]
  neighboring_tracts <- c_shp[c_shp$GISJOIN %in% neighboring_tracts$GISJOIN,]
  neighboring_tracts <- dplyr::left_join(neighboring_tracts, 
                                         sf::st_drop_geometry(i[,c("GISJOIN", "LABEL", "desig_date")]),
                                         by="GISJOIN")
  
  names(neighboring_tracts) <- gsub(x = names(neighboring_tracts), pattern=year, replacement = "")
  neighbor_tracts_summary <-
    sf::st_drop_geometry(neighboring_tracts) %>%
    mutate(num_black = totalpop * pctblack,
           num_white = totalpop * pctwhite) %>%
    select("LABEL", starts_with("num_"), "desig_date") %>%
    group_by(LABEL) %>%
      summarise(num_black = sum(num_black),
                num_white = sum(num_white),
                desig_year = max(desig_date, na.rm=T)) %>%
    mutate(pct_black_prorated = num_black / (num_black + num_white),
           pct_white_prorated = num_white / (num_black + num_white),
           desig_yet = ifelse(desig_year<year, 1, 0),
           year = year)
  
  rv = list("buffers" = b, 
            "neighbor_tracts" = neighboring_tracts, 
            "neighbor_tracts_summary" = neighbor_tracts_summary)
  
  return(rv)
}


nearby_tracts70 <- 
  get_neighbor_tracts(hd_shp=hd_shp, c_shp=c70_shp, buffer_dist=300, tracts_in_hd=hd_tracts70,.2, 1970)
nearby_tracts80 <- 
  get_neighbor_tracts(hd_shp=hd_shp, c_shp=c80_shp, buffer_dist=300, tracts_in_hd=hd_tracts80,.2, 1980)
nearby_tracts90 <- 
  get_neighbor_tracts(hd_shp=hd_shp, c_shp=c90_shp, buffer_dist=300, tracts_in_hd=hd_tracts90,.2, 1990)
gc()
nearby_tracts00 <- 
  get_neighbor_tracts(hd_shp=hd_shp, c_shp=c00_shp, buffer_dist=300, tracts_in_hd=hd_tracts00,.2, 2000)
nearby_tracts10 <- 
  get_neighbor_tracts(hd_shp=hd_shp, c_shp=c10_shp, buffer_dist=300, tracts_in_hd=hd_tracts10,.2, 2010)
nearby_tracts20 <- 
  get_neighbor_tracts(hd_shp=hd_shp, c_shp=c20_shp, buffer_dist=300, tracts_in_hd=hd_tracts20,.2, 2020)
gc()

leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(group='buffers', data=nearby_tracts20[["buffers"]]) %>%
  addPolygons(group= "tracts labeled as near HDs",
              data=nearby_tracts20[["neighbor_tracts"]],
              fillColor = "skyblue", 
              fillOpacity = 0.7,
              weight = 1,
              opacity = 1,
              color = "white",
              label=~paste0("Tract: ", NAME2020, "; HD neighbor: ", LABEL),
              highlightOptions = highlightOptions(weight = 3,
                                                  color = "white",
                                                  bringToFront = FALSE
        ) 
  ) %>%
  addPolygons(group= "HDs",
              data=hd_shp[hd_shp$desig_date < 2025,],
              fillColor = "hotpink", 
              fillOpacity = 0.7,
              weight = 1,
              opacity = 1,
              color = "white",
              label=~LABEL,
              highlightOptions = highlightOptions(weight = 3,
                                                  color = "white",
                                                  bringToFront = FALSE
        ) 
  ) %>%
  addLayersControl(
    overlayGroups = c("tracts labeled as near HDs", "HDs", "buffers"),
    options = layersControlOptions(collapsed = FALSE)
  )
```

Now compare the demographics of the HD tracts and their neighbors in each year:

```{r}

hd_comp_df <- dplyr::bind_rows(hd_tracts70[[2]], hd_tracts80[[2]], hd_tracts90[[2]],
                            hd_tracts00[[2]], hd_tracts10[[2]], hd_tracts20[[2]],)

hd_comp_df <-
  hd_comp_df %>%
  group_by(LABEL, desig_yet) %>%
  summarise(pct_black = round(100*mean(pct_black_prorated), 0),
            pct_white = round(100*mean(pct_white_prorated), 0)) %>%
  mutate(n_obs = n()) %>%
  filter(n_obs > 1) %>%
  rename_with(.cols = everything(), ~ paste0(., "_hd"))


near_comp_df <- dplyr::bind_rows(nearby_tracts70[[3]],nearby_tracts80[[3]], nearby_tracts90[[3]],
                            nearby_tracts00[[3]], nearby_tracts10[[3]], nearby_tracts20[[3]],)

near_comp_df <-
  near_comp_df %>%
  group_by(LABEL, desig_yet) %>%
  summarise(pct_black = round(100*mean(pct_black_prorated), 0),
            pct_white = round(100*mean(pct_white_prorated), 0)) %>%
  mutate(n_obs = n()) %>%
  filter(n_obs > 1) %>%
  rename_with(.cols = everything(), ~ paste0(., "_near"))


comp_df <- dplyr::left_join(x = hd_comp_df, 
                            y = near_comp_df, 
                            by = c("LABEL_hd"="LABEL_near", 
                                   "desig_yet_hd"="desig_yet_near")) %>% 
  ungroup() %>%
  filter(complete.cases(.)) %>%
  group_by(LABEL_hd) %>%
  mutate(n_obs = n()) %>%
  filter(n_obs > 1) %>%
  select(-starts_with("n_")) %>%
  arrange(desig_yet_hd) %>%
  mutate(change_black_hd = pct_black_hd - lag(pct_black_hd),
         change_black_near = pct_black_near - lag(pct_black_near),
         change_white_hd = pct_white_hd - lag(pct_white_hd),
         change_white_near = pct_white_near - lag(pct_white_near))


ggplot(comp_df %>% filter(desig_yet_hd==1)) +
  geom_point(aes(y = LABEL_hd, x=change_black_hd), color='hotpink') +
  geom_point(aes(y = LABEL_hd, x=change_black_near), color='skyblue') +
  ylab("") +
  xlab("Percentage point change in black residents")
```












